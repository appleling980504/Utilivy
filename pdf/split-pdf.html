<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Utilivy - Split & Group PDF</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <style>
    :root {
      --primary-color:#4f46e5;
      --bg-color:#f3f4f6;
      --text-color:#111827;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:'Inter',sans-serif;
      background-color:var(--bg-color);
      color:var(--text-color);
    }
    header{
      background:white;
      padding:1rem 2rem;
      box-shadow:0 2px 4px rgba(0,0,0,0.05);
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
    }
    .header-right{
      display:flex;
      align-items:center;
      gap:1rem;
    }
    .lang-switch button{
      background:var(--primary-color);
      color:white;
      border:none;
      border-radius:6px;
      padding:0.4rem 0.8rem;
      cursor:pointer;
    }
    header a{
      text-decoration:none;
      color:var(--primary-color);
      font-weight:500;
    }
    .adsense-banner,.adsense-footer{
      text-align:center;
      color:gray;
      display:none;
      margin:1rem 0;
    }
    .container{
      max-width:900px;
      margin:2rem auto;
      padding:2rem;
      background:white;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
    }
    label,button,input,textarea{
      margin-top:0.5rem;
      font-size:1rem;
    }
    input[type="file"],input[type="text"]{
      width:100%;
      padding:0.75rem;
      border:1px solid #d1d5db;
      border-radius:8px;
    }
    textarea{
      width:100%;
      height:60px;
      padding:0.75rem;
      border:1px solid #d1d5db;
      border-radius:8px;
    }
    #taskList,#previewList{
      list-style:none;
      padding:0;
      margin:1rem 0;
    }
    #taskList li,#previewList li{
      background:#f3f4f6;
      margin-bottom:0.5rem;
      padding:0.5rem;
      border-radius:6px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:move;
    }
    .group-btn, .del-btn{
      margin-left:0.5rem;
      padding:0.2rem 0.4rem;
      border:none;
      border-radius:4px;
      cursor:pointer;
    }
    .group-btn{
      background:#10b981;color:white;
    }
    .del-btn{
      background:#ef4444;color:white;
    }
    button.main-btn{
      background:var(--primary-color);
      color:white;
      border:none;
      padding:0.75rem 1.2rem;
      border-radius:8px;
      cursor:pointer;
      margin-right:0.5rem;
      margin-top:1rem;
    }
    footer{
      text-align:center;
      padding:1rem;
      font-size:0.9rem;
      color:#6b7280;
    }
  </style>
</head>
<body>
<header>
  <h1 data-en="Utilivy - Split & Group PDF" data-zh="Utilivy - 拆分并分组 PDF">Utilivy - Split & Group PDF</h1>
  <div class="header-right">
    <div class="lang-switch">
      <button onclick="setLang('en')">EN</button>
      <button onclick="setLang('zh')">中</button>
    </div>
    <a href="/">← <span data-en="Back to Home" data-zh="返回首页">Back to Home</span></a>
  </div>
</header>

<div class="adsense-banner"><p>[Ad Placeholder - Top]</p></div>

<div class="container">
  <label data-en="Upload PDF file" data-zh="上传 PDF 文件">Upload PDF file</label>
  <input type="file" id="pdfFile" accept="application/pdf"/>

  <label data-en="Enter page ranges (e.g. 1-3,5,7-9)" data-zh="输入页码范围（如 1-3,5,7-9）">Enter page ranges (e.g. 1-3,5,7-9)</label>
  <textarea id="ranges" placeholder="1-3,5,7-9"></textarea>

  <button class="main-btn" onclick="addTask()"
    data-en="Add Task" data-zh="添加任务">Add Task</button>

  <ul id="taskList"></ul>

  <button class="main-btn" onclick="processTasks()"
    data-en="Split & Preview" data-zh="拆分并预览">Split & Preview</button>

  <ul id="previewList"></ul>
</div>

<div class="adsense-footer"><p>[Ad Placeholder - Bottom]</p></div>

<footer>&copy; 2025 Utilivy. <span data-en="All rights reserved." data-zh="保留所有权利。">All rights reserved.</span></footer>

<script>
function setText() {
  document.querySelectorAll('[data-en]').forEach(el=>el.textContent=lang==='zh'?el.getAttribute('data-zh'):el.getAttribute('data-en'));
}
function setLang(l){
  window.lang = l;
  setText();
}
setLang('en');

let pdfBuf, pdfDoc;
document.getElementById('pdfFile').addEventListener('change',async e=>{
  const f=e.target.files[0];
  if(!f)return;
  pdfBuf=await f.arrayBuffer();
  pdfDoc=await PDFLib.PDFDocument.load(pdfBuf);
});

let tasks=[];
function addTask(){
  const ranges=document.getElementById('ranges').value.trim();
  if(!pdfDoc||!ranges)return alert('Please load PDF and enter ranges.');
  const list = parseRanges(ranges);
  if(!list.length)return alert('Invalid ranges.');
  tasks.push(list);
  renderTasks();
}
function parseRanges(text){
  const arr = text.split(',');
  const res=[];
  for(const part of arr){
    const m=part.match(/^(\d+)(?:-(\d+))?$/);
    if(m){
      const a=parseInt(m[1]),b=m[2]?parseInt(m[2]):a;
      if(a<=b && b<=pdfDoc.getPageCount()) res.push([a-1,b-1]);
    }
  }
  return res;
}
function renderTasks(){
  const el=document.getElementById('taskList');
  el.innerHTML='';
  tasks.forEach((r,i)=>{
    const li=document.createElement('li');
    li.draggable=true;
    li.dataset.idx=i;
    li.textContent = r.map(p=>`${p[0]+1}-${p[1]+1}`).join(', ');
    const btnDel=document.createElement('button');
    btnDel.textContent='×';btnDel.className='del-btn';
    btnDel.onclick=()=>{tasks.splice(i,1);renderTasks();}
    li.appendChild(btnDel);
    el.appendChild(li);
  });
  makeSortable('taskList');
}
function makeSortable(id){
  const ul=document.getElementById(id);
  let drag=null;
  Array.from(ul.children).forEach(li=>{
    li.addEventListener('dragstart',()=>drag=li);
    li.addEventListener('dragover',e=>e.preventDefault());
    li.addEventListener('drop',e=>{
      e.preventDefault();
      if(drag && drag!==li){
        ul.insertBefore(drag,li);
        const arr=[...ul.children].map(ch=>parseInt(ch.dataset.idx));
        tasks=arr.map(i=>tasks[i]);
        renderTasks();
      }
    });
  });
}

async function processTasks(){
  document.getElementById('previewList').innerHTML='';
  if(!tasks.length)return alert('Add tasks first.');
  for(const [idx,r] of tasks.entries()){
    const newPdf=await PDFLib.PDFDocument.create();
    for(const [a,b] of r){
      const pages=await newPdf.copyPages(pdfDoc,Array.from({length:b-a+1},(_,k)=>a+k));
      pages.forEach(p=>newPdf.addPage(p));
    }
    const bytes=await newPdf.save();
    const blob=new Blob([bytes],{type:'application/pdf'});
    const url=URL.createObjectURL(blob);
    const li=document.createElement('li');
    const chk=document.createElement('input');
    chk.type='checkbox';chk.checked=true;
    const link=document.createElement('a');
    link.href=url;link.textContent=`Task ${idx+1}: ${tasks[idx].map(p=>`${p[0]+1}-${p[1]+1}`).join(', ')}`;
    link.download=`part-${idx+1}.pdf`;
    li.appendChild(chk);li.appendChild(link);
    document.getElementById('previewList').appendChild(li);
  }
}

async function downloadSelected(){
  const lis=document.querySelectorAll('#previewList li');
  const selTasks=[]; lis.forEach((li,i)=>{
    if(li.querySelector('input').checked) selTasks.push(i);
  });
  if(!selTasks.length)return;
  const merged=await PDFLib.PDFDocument.create();
  for(const idx of selTasks){
    const blob=await fetch(document.querySelectorAll('#previewList a')[idx].href).then(r=>r.arrayBuffer());
    const part=await PDFLib.PDFDocument.load(blob);
    const pages=await merged.copyPages(part,part.getPageIndices());
    pages.forEach(p=>merged.addPage(p));
  }
  const out=await merged.save();
  const url=URL.createObjectURL(new Blob([out],{type:'application/pdf'}));
  const a=document.createElement('a');
  a.href=url;a.download='merged-selected.pdf';a.click();
}

function downloadAll(){downloadSelected();}
