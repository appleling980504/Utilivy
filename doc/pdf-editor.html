<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF Editor / ç¼–è¾‘å™¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sortable/1.15.0/Sortable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #f7f7f7; }
    #pdf-preview { display: flex; flex-wrap: wrap; gap: 10px; }
    .pdf-page { border: 1px solid #ccc; position: relative; }
    .pdf-page canvas { border: 1px solid #000; }
    .controls { margin: 1rem 0; }
    .draggable { position: absolute; cursor: move; }
    #editor-toolbar button { margin: 0 0.5rem 0.5rem 0; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>PDF Editor / ç¼–è¾‘å™¨</h1>

  <div class="controls">
    <input type="file" id="pdf-upload" accept="application/pdf" />
    <button onclick="addText()">â• Add Text</button>
    <button onclick="addSignature()">âœï¸ Add Signature</button>
    <input type="file" id="image-upload" accept="image/*" onchange="addImage(event)" />
    <button onclick="deleteSelectedPage()">âœ‚ï¸ Delete Selected Page</button>
    <button onclick="exportPDF()">ğŸ“¤ Export PDF</button>
  </div>

  <div id="pdf-preview"></div>

  <script>
    let pdfDoc, pages = [], selectedPageIndex = null;

    document.getElementById('pdf-upload').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const arrayBuffer = await file.arrayBuffer();
      const loadingTask = window.pdfjsLib.getDocument({ data: arrayBuffer });
      const pdf = await loadingTask.promise;
      pdfDoc = pdf;
      pages = [];
      document.getElementById('pdf-preview').innerHTML = '';

      for (let i = 0; i < pdf.numPages; i++) {
        const page = await pdf.getPage(i + 1);
        const viewport = page.getViewport({ scale: 1 });
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await page.render({ canvasContext: context, viewport }).promise;

        const container = document.createElement('div');
        container.className = 'pdf-page';
        container.appendChild(canvas);
        container.setAttribute('data-index', i);
        container.addEventListener('click', () => {
          document.querySelectorAll('.pdf-page').forEach(p => p.style.outline = '');
          container.style.outline = '3px solid #007bff';
          selectedPageIndex = i;
        });
        document.getElementById('pdf-preview').appendChild(container);
        pages.push(canvas);
      }

      Sortable.create(document.getElementById('pdf-preview'), {
        animation: 150,
        onEnd: (e) => {
          const item = pages.splice(e.oldIndex, 1)[0];
          pages.splice(e.newIndex, 0, item);
        }
      });
    });

    function addText() {
      if (selectedPageIndex === null) return alert("Please select a page first");
      const pageEl = document.querySelectorAll('.pdf-page')[selectedPageIndex];
      const text = prompt("Enter text:");
      const div = document.createElement('div');
      div.className = 'draggable';
      div.contentEditable = true;
      div.style.left = '10px';
      div.style.top = '10px';
      div.style.fontSize = '16px';
      div.textContent = text || 'Sample Text';
      makeDraggable(div);
      pageEl.appendChild(div);
    }

    function addSignature() {
      const signText = prompt("Sign with your name:");
      if (!signText) return;
      const pageEl = document.querySelectorAll('.pdf-page')[selectedPageIndex];
      const div = document.createElement('div');
      div.className = 'draggable';
      div.style.left = '10px';
      div.style.top = '100px';
      div.style.fontSize = '18px';
      div.style.fontStyle = 'italic';
      div.textContent = signText;
      makeDraggable(div);
      pageEl.appendChild(div);
    }

    function addImage(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (event) {
        const img = document.createElement('img');
        img.src = event.target.result;
        img.style.width = '100px';
        img.className = 'draggable';
        img.style.left = '10px';
        img.style.top = '150px';
        makeDraggable(img);
        const pageEl = document.querySelectorAll('.pdf-page')[selectedPageIndex];
        pageEl.appendChild(img);
      };
      reader.readAsDataURL(file);
    }

    function deleteSelectedPage() {
      if (selectedPageIndex === null) return alert("No page selected");
      pages.splice(selectedPageIndex, 1);
      document.querySelectorAll('.pdf-page')[selectedPageIndex].remove();
      selectedPageIndex = null;
    }

    function exportPDF() {
      alert("ğŸ“¢ PDF å¯¼å‡ºåŠŸèƒ½è¯·ç­‰å¾…ç¬¬äºŒé˜¶æ®µå®ç°ï¼ˆåŸºäº fabric æˆ– html2canvas + pdf-lib ç»˜åˆ¶ï¼‰");
    }

    function makeDraggable(el) {
      el.style.position = 'absolute';
      el.draggable = true;
      el.addEventListener('dragstart', e => {
        e.dataTransfer.setData("text/plain", null);
        el.dataset.dragging = "true";
      });
      el.addEventListener('dragend', e => {
        el.dataset.dragging = "false";
        const rect = el.parentElement.getBoundingClientRect();
        el.style.left = `${e.pageX - rect.left - el.offsetWidth / 2}px`;
        el.style.top = `${e.pageY - rect.top - el.offsetHeight / 2}px`;
      });
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
</body>
</html>
