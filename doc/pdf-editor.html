<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF Editor / PDF编辑工具</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 1rem; background: #f0f0f0; }
    .container { max-width: 960px; margin: auto; background: #fff; padding: 1rem; border-radius: 8px; }
    .controls { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
    .signature-pad { border: 1px solid #aaa; width: 300px; height: 150px; }
    canvas { border: 1px solid #ddd; margin-top: 1rem; }
  </style>
</head>
<body>
<div class="container">
  <h2>📄 PDF Editor / PDF编辑工具</h2>
  <div class="controls">
    <input type="file" id="pdf-upload" accept="application/pdf">
    <input type="file" id="image-upload" accept="image/*">
    <button onclick="addSignature()">✍️ 添加签名</button>
    <button onclick="addImage()">📷 插入图像</button>
    <button onclick="deletePage()">✂️ 删除当前页</button>
    <button onclick="downloadPDF()">💾 导出 PDF</button>
  </div>

  <canvas id="pdf-canvas" width="600" height="800"></canvas>

  <h3>✍️ 签名区域：</h3>
  <canvas id="signature-pad" class="signature-pad"></canvas>
  <br><button onclick="clearSignature()">清除签名</button>
</div>

<script>
  let pdfDoc = null;
  let currentPage = 0;
  let canvas = document.getElementById("pdf-canvas");
  let ctx = canvas.getContext("2d");
  let signaturePad = document.getElementById("signature-pad");
  let sigCtx = signaturePad.getContext("2d");
  let uploadedImages = [];

  // 签名功能
  let drawing = false;
  signaturePad.addEventListener("mousedown", () => drawing = true);
  signaturePad.addEventListener("mouseup", () => {
    drawing = false;
    sigCtx.beginPath();
  });
  signaturePad.addEventListener("mousemove", (e) => {
    if (!drawing) return;
    const rect = signaturePad.getBoundingClientRect();
    sigCtx.lineWidth = 2;
    sigCtx.lineCap = "round";
    sigCtx.strokeStyle = "black";
    sigCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    sigCtx.stroke();
    sigCtx.beginPath();
    sigCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
  });
  function clearSignature() {
    sigCtx.clearRect(0, 0, signaturePad.width, signaturePad.height);
  }

  // 加载 PDF
  document.getElementById("pdf-upload").addEventListener("change", async (e) => {
    const file = e.target.files[0];
    const arrayBuffer = await file.arrayBuffer();
    pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
    renderPage(0);
  });

  async function renderPage(index) {
    currentPage = index;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#eee";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#000";
    ctx.font = "20px sans-serif";
    ctx.fillText("这是 PDF 页面的占位图。编辑内容将直接作用于 PDF 文件本身。", 50, 100);
  }

  document.getElementById("image-upload").addEventListener("change", (e) => {
    const reader = new FileReader();
    reader.onload = () => uploadedImages.push(reader.result);
    reader.readAsDataURL(e.target.files[0]);
  });

  async function addSignature() {
    if (!pdfDoc) return;
    const sigDataUrl = signaturePad.toDataURL("image/png");
    const img = await pdfDoc.embedPng(sigDataUrl);
    const page = pdfDoc.getPages()[currentPage];
    page.drawImage(img, { x: 100, y: 400, width: 150, height: 75 });
    alert("签名已添加！");
  }

  async function addImage() {
    if (!pdfDoc || uploadedImages.length === 0) return;
    const imgData = uploadedImages.pop();
    const img = await pdfDoc.embedPng(imgData);
    const page = pdfDoc.getPages()[currentPage];
    page.drawImage(img, { x: 50, y: 500, width: 150, height: 100 });
    alert("图像已添加！");
  }

  async function deletePage() {
    if (!pdfDoc) return;
    pdfDoc.removePage(currentPage);
    if (pdfDoc.getPageCount() > 0) {
      renderPage(0);
    } else {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      alert("已删除所有页面。");
    }
  }

  async function downloadPDF() {
    if (!pdfDoc) return;
    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type: "application/pdf" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "modified.pdf";
    link.click();
  }
</script>
</body>
</html>
